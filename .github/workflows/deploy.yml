name: Java CI with Maven

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  java-version: "17"
                  distribution: "temurin"
                  cache: maven

            - name: Cache Maven packages
              uses: actions/cache@v4
              with:
                  path: ~/.m2
                  key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
                  restore-keys: ${{ runner.os }}-m2

            - name: Clear Maven Cache (Optional)
              run: rm -rf ~/.m2/repository/com/project # ❗ 손상된 JAR 방지

            - name: Build with Maven
              working-directory: final
              run: mvn -B clean package

            - name: Verify WAR file exists before upload
              working-directory: final
              run: ls -al target

            - name: Upload build artifact (WAR file)
              uses: actions/upload-artifact@v4
              with:
                  name: trelloServer
                  path: final/target/trelloServer.war # ✅ 명확한 파일 지정

    deploy:
        needs: build
        runs-on: ubuntu-latest
        steps:
            - name: Download build artifact
              uses: actions/download-artifact@v4
              with:
                  name: trelloServer
                  path: final/target/

            - name: Verify WAR file exists after download
              run: ls -al final/target/

            - name: Deploy to EC2
              run: |
                  echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
                  chmod 600 private_key.pem

                  # Tomcat 중지 후 기존 파일 삭제
                  ssh -i private_key.pem -o StrictHostKeyChecking=no ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
                    sudo systemctl stop tomcat
                    sudo rm -rf /home/tomcat/apache-tomcat-10.1.34/webapps/trelloServer.war
