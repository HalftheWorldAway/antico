name: Java CI with Maven

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  java-version: "17"
                  distribution: "temurin"
                  cache: maven

            - name: Cache Maven packages
              uses: actions/cache@v4
              with:
                  path: ~/.m2
                  key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
                  restore-keys: ${{ runner.os }}-m2

            - name: Build with Maven
              run: mvn -B clean package --file pom.xml

            - name: Upload build artifact (WAR file)
              uses: actions/upload-artifact@v4
              with:
                  name: trelloServer
                  path: target/*.war

    deploy:
        needs: build
        runs-on: ubuntu-latest

        steps:
            - name: Download build artifact
              uses: actions/download-artifact@v4
              with:
                  name: trelloServer
                  path: target/

            - name: Deploy to EC2
              run: |
                  echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
                  chmod 600 private_key.pem
                  scp -i private_key.pem -o StrictHostKeyChecking=no target/*.war ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USERNAME }}/trelloServer.war
                  ssh -i private_key.pem -o StrictHostKeyChecking=no ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
                    sudo systemctl restart tomcat
                  EOF
                  rm -f private_key.pem
